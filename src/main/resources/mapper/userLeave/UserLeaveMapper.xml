<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.codeplay.mapper.userLeave.UserLeaveMapper">
	
	<select id="getUserLeave" parameterType="Integer" resultType="LeaveVo">
        select * from leave where user_no = #{user_no}
    </select>
    
    <select id="getUserLeaveWait" parameterType="Integer" resultType="com.codeplay.domain.leave.dto.Leave_WaitDto">
        select * from leave_approval where user_no = #{user_no}
    </select>
    
    <select id="getUserLeaveRequest2" parameterType="Integer" resultType="com.codeplay.domain.leave.dto.UserLeaveApprovalLineDto">
		SELECT la.leaveapp_no, 
       la.user_no,
       la.leaveapp_content,
       la.leaveapp_start,
       la.leaveapp_end,
       la.leaveapp_type,
       la.leaveapp_total,
       MAX(CASE WHEN rn = 1 THEN u.user_name END) AS "one",
       MAX(CASE WHEN rn = 2 THEN u.user_name END) AS "two",
       la.leaveapp_status
	FROM (
	  SELECT lal.*, ROW_NUMBER() OVER (PARTITION BY lal.leaveapp_no ORDER BY lal.leaveappln_order) AS rn
	  FROM leave_approval_line lal
	) lal
	INNER JOIN leave_approval la ON lal.leaveapp_no = la.leaveapp_no
	INNER JOIN users u ON u.user_no = lal.leaveappln_user_no
	WHERE la.user_no  = #{user_no}
	GROUP BY la.leaveapp_no, la.user_no, la.leaveapp_content, la.leaveapp_start, la.leaveapp_end, la.leaveapp_type, la.leaveapp_total, la.leaveapp_final_date, la.leaveapp_status
	ORDER BY la.leaveapp_no DESC
    </select>
    
</mapper>

